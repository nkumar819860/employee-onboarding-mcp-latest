# Connected App Auto-Provisioning Guide

## Overview ğŸ¯

This guide provides an **automated solution** to resolve the 401 authentication errors by creating a Connected App with **full permissions** for Exchange publication and CloudHub deployment, including **MFA support**.

## Features âœ¨

âœ… **Automated Connected App Creation** - No manual setup required  
âœ… **MFA Support** - Seamless multi-factor authentication  
âœ… **Full Permissions** - Exchange, CloudHub, Runtime Manager, API Manager access  
âœ… **Credential Management** - Auto-generates `.env` file  
âœ… **Test Scripts** - Validation and deployment automation  
âœ… **Security Best Practices** - Secure credential handling  

## Prerequisites ğŸ“‹

### 1. Install Anypoint CLI
```bash
npm install -g anypoint-cli
```

### 2. Verify Installation
```bash
anypoint-cli --version
```

### 3. Anypoint Platform Access
- Valid Anypoint Platform account
- Organization administrator privileges (recommended)
- MFA configured (if enabled on your account)

## Quick Start ğŸš€

### Step 1: Run Auto-Provisioning Script
```bash
cd employee-onboarding-agent-fabric
auto-provision-connected-app.bat
```

### Step 2: Follow Interactive Prompts
1. **Username**: Enter your Anypoint Platform username
2. **Password**: Enter password (hidden input for security)  
3. **MFA**: Complete MFA challenge if prompted
4. **Confirmation**: Review and approve Connected App creation

### Step 3: Verify Setup
```bash
test-connected-app-credentials.bat
```

### Step 4: Deploy Everything
```bash
deploy-with-connected-app.bat
```

## What Gets Created ğŸ“

### Generated Files:
- âœ… **`.env`** - Complete credentials configuration
- âœ… **`test-connected-app-credentials.bat`** - Credential validation script
- âœ… **`deploy-with-connected-app.bat`** - Full deployment automation

### Connected App Configuration:
```json
{
  "name": "Employee-Onboarding-MCP-ConnectedApp",
  "scopes": [
    "full",
    "cloudhub:application:read",
    "cloudhub:application:write",
    "exchange:asset:read", 
    "exchange:asset:write",
    "runtime-manager:application:read",
    "runtime-manager:application:write",
    "api-manager:api:read",
    "api-manager:api:write"
  ]
}
```

## Generated .env File Structure ğŸ“

```bash
# ========================================
# ANYPOINT PLATFORM CREDENTIALS
# ========================================
# Auto-generated by auto-provision-connected-app.bat

# ğŸ” CONNECTED APP CREDENTIALS
ANYPOINT_CLIENT_ID=your-client-id-here
ANYPOINT_CLIENT_SECRET=your-client-secret-here
ANYPOINT_ORG_ID=your-org-id-here

# ğŸ¢ ORGANIZATION DETAILS  
ANYPOINT_BUSINESS_GROUP=your-org-id-here
ANYPOINT_PLATFORM_ENV=Sandbox

# ğŸŒ PLATFORM URLS
ANYPOINT_PLATFORM_URI=https://anypoint.mulesoft.com
ANYPOINT_EXCHANGE_URI=https://maven.anypoint.mulesoft.com/api/v3/organizations/your-org-id/maven

# ğŸ‘¤ USER CREDENTIALS (for manual operations)
ANYPOINT_USERNAME=your-username@company.com
# ANYPOINT_PASSWORD=(not stored for security)

# ğŸš€ DEPLOYMENT SETTINGS
CLOUDHUB_REGION=us-east-1
CLOUDHUB_WORKER_TYPE=MICRO
CLOUDHUB_WORKERS=1
MULE_RUNTIME_VERSION=4.9-java17
```

## Step-by-Step Process Details ğŸ”§

### Phase 1: Prerequisites Validation
- âœ… Validates Anypoint CLI installation
- âœ… Checks for JSON parsing tools (jq or PowerShell)
- âœ… Confirms environment readiness

### Phase 2: Authentication
- ğŸ” Prompts for Anypoint Platform credentials
- ğŸ”’ Uses secure password input (hidden)
- ğŸ“± Supports MFA prompts automatically
- âœ… Validates successful authentication

### Phase 3: Organization Discovery  
- ğŸ¢ Retrieves organization information
- ğŸ†” Extracts organization ID and name
- ğŸ“‹ Displays organization details for confirmation

### Phase 4: Connected App Creation
- ğŸ—ï¸ Creates Connected App with comprehensive scopes
- ğŸ”‘ Generates secure client credentials
- ğŸ“¦ Configures Exchange and CloudHub permissions
- âœ… Confirms successful creation

### Phase 5: Configuration Generation
- ğŸ“„ Creates `.env` file with all credentials
- ğŸ”§ Generates test and deployment scripts  
- ğŸ§ª Tests credential validity
- ğŸ“‹ Provides comprehensive setup summary

## Troubleshooting ğŸ”

### Common Issues and Solutions:

#### 1. Anypoint CLI Not Found
```bash
# Error: Anypoint CLI not found
# Solution:
npm install -g anypoint-cli
```

#### 2. Authentication Failed
```bash
# Error: Failed to authenticate with Anypoint Platform
# Solutions:
# - Verify username and password
# - Complete MFA challenge
# - Check account status
# - Ensure organization access
```

#### 3. Insufficient Permissions
```bash
# Error: Failed to create Connected App
# Solutions:
# - Use organization administrator account
# - Request Connected App creation permissions
# - Create manually in Anypoint Platform
```

#### 4. MFA Issues
```bash
# Error: MFA prompt not working
# Solutions:
# - Ensure MFA device is accessible
# - Try logging in manually first
# - Contact your organization admin
```

### Manual Connected App Creation (Fallback)

If automated creation fails:

1. **Go to Anypoint Platform** â†’ Access Management â†’ Connected Apps
2. **Click "Create App"**
3. **Configure:**
   - Name: `Employee-Onboarding-MCP-ConnectedApp`
   - Grant Types: `Client Credentials`, `Authorization Code`
   - Scopes: `Full Access` (or specific scopes listed above)
4. **Save and Copy Credentials** to `.env` file manually

## Security Best Practices ğŸ”’

### Credential Management:
- âœ… `.env` file contains sensitive credentials
- âœ… Add `.env` to `.gitignore` (already configured)
- âœ… Never commit credentials to version control
- âœ… Use environment-specific credentials
- âœ… Rotate credentials regularly

### Access Control:
- âœ… Use least-privilege principle
- âœ… Monitor Connected App usage
- âœ… Review and audit permissions
- âœ… Deactivate unused apps

## Usage Examples ğŸ’¡

### Test Credentials Only:
```bash
test-connected-app-credentials.bat
```

### Publish Parent POM Only:
```bash
# Uses credentials from .env automatically
publish-parent-to-exchange.bat
```

### Deploy All MCP Servers:
```bash
# Uses credentials from .env automatically  
deploy-all-mcp-servers.bat
```

### Complete End-to-End Deployment:
```bash
deploy-with-connected-app.bat
```

## Advanced Configuration âš™ï¸

### Custom Environment Variables:
You can modify the generated `.env` file to customize:

```bash
# Custom CloudHub settings
CLOUDHUB_REGION=us-west-2
CLOUDHUB_WORKER_TYPE=SMALL
CLOUDHUB_WORKERS=2

# Custom environment
ANYPOINT_PLATFORM_ENV=Production

# Custom runtime
MULE_RUNTIME_VERSION=4.10-java17
```

### Multiple Environments:
Create environment-specific `.env` files:
- `.env.sandbox` - Sandbox environment
- `.env.production` - Production environment  
- `.env.staging` - Staging environment

## Integration with Existing Scripts ğŸ”—

All existing deployment scripts will automatically use the new credentials:

- âœ… `publish-parent-to-exchange.bat` - Fixed parent POM publication
- âœ… `deploy-all-mcp-servers.bat` - MCP server deployment
- âœ… All CloudHub deployment scripts
- âœ… Exchange publication scripts

No modifications needed - they automatically load from `.env`!

## Monitoring and Maintenance ğŸ“Š

### Regular Tasks:
1. **Monthly**: Review Connected App usage in Anypoint Platform
2. **Quarterly**: Rotate client credentials for security
3. **As Needed**: Update permissions for new features
4. **Monitor**: Watch for authentication failures in logs

### Health Check:
```bash
# Quick validation
test-connected-app-credentials.bat

# Full deployment test
deploy-with-connected-app.bat
```

## Success Indicators âœ…

After running the auto-provisioning script, you should see:

1. **âœ… Connected App Created** - New app visible in Anypoint Platform
2. **âœ… Credentials Generated** - `.env` file with client_id and client_secret
3. **âœ… Test Scripts Created** - Validation and deployment automation
4. **âœ… Authentication Working** - No more 401 errors
5. **âœ… Exchange Access** - Can publish parent POM
6. **âœ… CloudHub Access** - Can deploy MCP servers

## Next Steps ğŸ¯

1. **Run**: `auto-provision-connected-app.bat`
2. **Test**: `test-connected-app-credentials.bat`  
3. **Deploy**: `deploy-with-connected-app.bat`
4. **Verify**: Check Anypoint Platform for deployed assets
5. **Monitor**: Regular health checks and credential rotation

## Support ğŸ›Ÿ

If you encounter issues:
1. Check the troubleshooting section above
2. Review Anypoint Platform documentation
3. Verify organization permissions
4. Contact your Anypoint Platform administrator

---

**ğŸ‰ This automated solution eliminates the 401 authentication errors and provides a complete deployment pipeline for your Employee Onboarding MCP system!**
