# Employee Onboarding Agent Fabric - Deployment Configuration
# This file defines the complete deployment configuration for the agent fabric

apiVersion: agentfabric.mulesoft.com/v1
kind: DeploymentConfig
metadata:
  name: employee-onboarding-agent-fabric
  version: "1.0.0"
  description: "Complete agent fabric deployment configuration for employee onboarding process"

# Environment Configuration
environments:
  development:
    name: "Development"
    muleEnvironment: "Sandbox"
    runtimeVersion: "4.11.1:2e-java17"
    region: "us-east-1"
    workerSize: 0.1
    workers: 1
    enableLogs: true
    logLevel: "DEBUG"
    
  staging:
    name: "Staging"
    muleEnvironment: "Sandbox"
    runtimeVersion: "4.11.1:2e-java17"
    region: "us-east-1"
    workerSize: 0.2
    workers: 1
    enableLogs: true
    logLevel: "INFO"
    
  production:
    name: "Production"
    muleEnvironment: "Production"
    runtimeVersion: "4.11.1:2e-java17"
    region: "us-east-1"
    workerSize: 0.5
    workers: 2
    enableLogs: true
    logLevel: "WARN"

# MCP Server Deployment Configuration
mcpServers:
  - name: "employee-onboarding-mcp"
    displayName: "Employee Onboarding MCP Server"
    description: "Employee management and profile creation services"
    path: "./mcp-servers/employee-onboarding-mcp"
    buildCommand: "mvn clean package -DskipTests"
    artifacts:
      - "target/employee-onboarding-mcp-1.0.0-mule-application.jar"
    dependencies: []
    healthCheck: "/health"
    environment:
      DATABASE_URL: "${DATABASE_URL}"
      LOG_LEVEL: "${LOG_LEVEL}"
    
  - name: "asset-allocation-mcp"
    displayName: "Asset Allocation MCP Server"
    description: "Asset management and allocation services"
    path: "./mcp-servers/asset-allocation-mcp"
    buildCommand: "mvn clean package -DskipTests"
    artifacts:
      - "target/asset-allocation-mcp-1.0.0-mule-application.jar"
    dependencies: []
    healthCheck: "/health"
    environment:
      DATABASE_URL: "${DATABASE_URL}"
      LOG_LEVEL: "${LOG_LEVEL}"
    
  - name: "notification-mcp"
    displayName: "Notification MCP Server"
    description: "Email notification and communication services"
    path: "./mcp-servers/notification-mcp"
    buildCommand: "mvn clean package -DskipTests"
    artifacts:
      - "target/notification-mcp-1.0.0-mule-application.jar"
    dependencies: []
    healthCheck: "/health"
    environment:
      EMAIL_FROM_ADDRESS: "${EMAIL_FROM_ADDRESS}"
      EMAIL_PASSWORD: "${EMAIL_PASSWORD}"
      LOG_LEVEL: "${LOG_LEVEL}"
    
  - name: "agent-broker-mcp"
    displayName: "Agent Broker MCP Server"
    description: "Agent orchestration and process coordination services"
    path: "./mcp-servers/agent-broker-mcp"
    buildCommand: "mvn clean package -DskipTests"
    artifacts:
      - "target/employee-onboarding-agent-broker-1.0.0-mule-application.jar"
    dependencies: 
      - "employee-onboarding-mcp"
      - "asset-allocation-mcp" 
      - "notification-mcp"
    healthCheck: "/health"
    environment:
      GROQ_API_KEY: "${GROQ_API_KEY}"
      LOG_LEVEL: "${LOG_LEVEL}"

# Deployment Sequence Configuration
deploymentSequence:
  - phase: "preparation"
    name: "Pre-deployment Preparation"
    steps:
      - name: "validate-configuration"
        description: "Validate all configuration files"
        script: "./deployment/scripts/validate-config.bat"
        
      - name: "check-prerequisites"
        description: "Check system prerequisites and dependencies"
        script: "./deployment/scripts/check-prerequisites.bat"
        
      - name: "backup-existing"
        description: "Backup existing deployments"
        script: "./deployment/scripts/backup-deployments.bat"
        
  - phase: "build"
    name: "Build All MCP Servers"
    steps:
      - name: "build-mcp-servers"
        description: "Build all MCP server applications"
        script: "./deployment/scripts/build-all.bat"
        parallel: true
        
  - phase: "deploy-core"
    name: "Deploy Core MCP Servers"
    steps:
      - name: "deploy-employee-mcp"
        description: "Deploy Employee Onboarding MCP Server"
        script: "./deployment/scripts/deploy-single-mcp.bat"
        args: ["employee-onboarding-mcp"]
        
      - name: "deploy-asset-mcp"
        description: "Deploy Asset Allocation MCP Server"
        script: "./deployment/scripts/deploy-single-mcp.bat"
        args: ["asset-allocation-mcp"]
        dependsOn: ["deploy-employee-mcp"]
        
      - name: "deploy-notification-mcp"
        description: "Deploy Notification MCP Server"
        script: "./deployment/scripts/deploy-single-mcp.bat"
        args: ["notification-mcp"]
        dependsOn: ["deploy-employee-mcp"]
        
  - phase: "deploy-orchestration"
    name: "Deploy Orchestration Layer"
    steps:
      - name: "deploy-agent-broker"
        description: "Deploy Agent Broker MCP Server"
        script: "./deployment/scripts/deploy-single-mcp.bat"
        args: ["agent-broker-mcp"]
        dependsOn: ["deploy-employee-mcp", "deploy-asset-mcp", "deploy-notification-mcp"]
        
  - phase: "configure-gateway"
    name: "Configure Flex Gateway"
    steps:
      - name: "deploy-gateway-config"
        description: "Deploy Flex Gateway configuration"
        script: "./deployment/scripts/deploy-gateway.bat"
        dependsOn: ["deploy-agent-broker"]
        
  - phase: "verification"
    name: "Post-deployment Verification"
    steps:
      - name: "health-check-all"
        description: "Perform health checks on all deployed services"
        script: "./deployment/scripts/health-check-all.bat"
        
      - name: "integration-test"
        description: "Run integration tests"
        script: "./deployment/scripts/run-integration-tests.bat"
        
      - name: "validate-agent-network"
        description: "Validate agent network configuration"
        script: "./deployment/scripts/validate-agent-network.bat"

# Monitoring and Alerting Configuration
monitoring:
  enabled: true
  healthCheckInterval: "30s"
  alerting:
    enabled: true
    webhookUrl: "${ALERT_WEBHOOK_URL}"
    channels:
      - email: "${ALERT_EMAIL}"
      - slack: "${SLACK_WEBHOOK_URL}"
  metrics:
    - name: "deployment_success_rate"
      description: "Percentage of successful deployments"
      threshold: 95
      
    - name: "health_check_success_rate"
      description: "Percentage of successful health checks"
      threshold: 98
      
    - name: "response_time"
      description: "Average response time for MCP servers"
      threshold: 2000 # milliseconds

# Security Configuration
security:
  encryption:
    enabled: true
    algorithm: "AES-256"
  secretsManagement:
    provider: "anypoint-secrets"
    keyVault: "${KEY_VAULT_NAME}"
  apiSecurity:
    authentication: "oauth2"
    authorization: "rbac"

# Rollback Configuration
rollback:
  enabled: true
  automaticRollback:
    enabled: true
    conditions:
      - "health_check_failure"
      - "integration_test_failure"
  backupRetention: 5 # Number of backup versions to keep
