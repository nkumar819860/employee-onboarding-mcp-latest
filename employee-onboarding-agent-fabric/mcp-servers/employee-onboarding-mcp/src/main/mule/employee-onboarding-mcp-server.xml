<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:db="http://www.mulesoft.org/schema/mule/db"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:http="http://www.mulesoft.org/schema/mule/http"
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">

    <!-- ========================= -->
    <!-- CREATE EMPLOYEE (POST)    -->
    <!-- ========================= -->

    <flow name="create-employee-flow">
        <http:listener config-ref="HTTP_Listener_config"
                       path="/employees"
                       allowedMethods="POST"/>

        <try>

            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/db
---
{
    employee_id: payload.employeeId,
    first_name: payload.firstName,
    last_name: payload.lastName,
    email: payload.email,
    phone: payload.phone,
    department_id: payload.departmentId,
    position: payload.position,
    hire_date: payload.hireDate,
    status: "PENDING",
    salary: payload.salary,
    address: payload.address,
    emergency_contact_name: payload.emergencyContactName,
    emergency_contact_phone: payload.emergencyContactPhone
}]]></ee:set-payload>
                </ee:message>
            </ee:transform>

            <db:insert config-ref="Database_Config">
                <db:sql><![CDATA[
                    INSERT INTO employees
                    (employee_id, first_name, last_name, email, phone,
                     department_id, position, hire_date, status, salary,
                     address, emergency_contact_name, emergency_contact_phone)
                    VALUES
                    (:employee_id, :first_name, :last_name, :email, :phone,
                     :department_id, :position, :hire_date, :status, :salary,
                     :address, :emergency_contact_name, :emergency_contact_phone)
                ]]></db:sql>
            </db:insert>

            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    message: "Employee created successfully",
    employeeId: payload.employee_id
}]]></ee:set-payload>
                </ee:message>
            </ee:transform>

        <error-handler>

            <!-- Duplicate key -->
<on-error-continue type="DB:QUERY_EXECUTION"
    when="#[error.description contains 'Duplicate' or error.description contains 'duplicate']">
                    <ee:transform>
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    error: "Employee ID or email already exists"
}]]></ee:set-payload>
                    </ee:message>
                </ee:transform>
            </on-error-continue>

            <!-- DB Down → Mock -->
            <on-error-continue type="DB:*">
                <ee:transform>
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    message: "Employee created (MOCK MODE)",
    employeeId: uuid(),
    mockMode: true
}]]></ee:set-payload>
                    </ee:message>
                </ee:transform>
            </on-error-continue>

        </error-handler>
        </try>
    </flow>


    <!-- ========================= -->
    <!-- GET EMPLOYEE (GET)        -->
    <!-- ========================= -->

    <flow name="get-employee-flow">
        <http:listener config-ref="HTTP_Listener_config"
                       path="/employees/{empId}" 
                       allowedMethods="GET"/>

        <set-variable variableName="empId"
                      value="#[attributes.uriParams.empId]"/>

        <try>

            <db:select config-ref="Database_Config">
                <db:sql>
                    SELECT * FROM employees
                    WHERE employee_id = :empId
                </db:sql>
                <db:input-parameters>
                    #[{empId: vars.empId}]
                </db:input-parameters>
            </db:select>

            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
if (payload.size() > 0)
    payload[0]
else
    { message: "Employee not found" }
]]></ee:set-payload>
                </ee:message>
            </ee:transform>

        <error-handler>

            <!-- DB Down → Mock -->
            <on-error-continue type="DB:*">
                <ee:transform>
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    employee_id: vars.empId,
    first_name: "Mock",
    last_name: "User",
    email: "mock.user@company.com",
    status: "ACTIVE",
    mockMode: true
}]]></ee:set-payload>
                    </ee:message>
                </ee:transform>
            </on-error-continue>

        </error-handler>
        </try>
    </flow>


    <!-- ========================= -->
    <!-- LIST EMPLOYEES (GET)      -->
    <!-- ========================= -->

    <flow name="list-employees-flow">
        <http:listener config-ref="HTTP_Listener_config"
                       path="/employees"
                       allowedMethods="GET"/>

        <try>

            <db:select config-ref="Database_Config">
                <db:sql>
                    SELECT * FROM employees
                    ORDER BY created_at DESC
                </db:sql>
            </db:select>

            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload
]]></ee:set-payload>
                </ee:message>
            </ee:transform>

        <error-handler>

            <!-- DB Down → Mock -->
            <on-error-continue type="DB:*">
                <ee:transform>
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
[
 {
   employee_id: "EMP001",
   first_name: "John",
   last_name: "Smith",
   email: "john.smith@company.com",
   status: "ACTIVE",
   mockMode: true
 },
 {
   employee_id: "EMP002",
   first_name: "Maria",
   last_name: "Garcia",
   email: "maria.garcia@company.com",
   status: "PENDING",
   mockMode: true
 }
]
]]></ee:set-payload>
                </ee:message>
            </ee:transform>
            </on-error-continue>

        </error-handler>
        </try>
    </flow>


    <!-- ========================= -->
    <!-- UPDATE STATUS (PUT)       -->
    <!-- ========================= -->

    <flow name="update-employee-status-flow">
        <http:listener config-ref="HTTP_Listener_config"
                       path="/employees/{empId}/status/{status}"
                       allowedMethods="PUT"/>

        <set-variable variableName="empId"
                      value="#[attributes.uriParams.empId]"/>

        <set-variable variableName="status"
                      value="#[attributes.uriParams.status]"/>

        <try>

            <db:update config-ref="Database_Config">
                <db:sql>
                    UPDATE employees
                    SET status = :status,
                        updated_at = CURRENT_TIMESTAMP
                    WHERE employee_id = :empId
                </db:sql>
                <db:input-parameters>
                    #[{empId: vars.empId, status: vars.status}]
                </db:input-parameters>
            </db:update>

            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    message: "Status updated to " ++ vars.status,
    employeeId: vars.empId
}
]]></ee:set-payload>
                </ee:message>
            </ee:transform>

        <error-handler>

            <!-- DB Down → Mock -->
            <on-error-continue type="DB:*">
                <ee:transform>
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    message: "Status updated to " ++ vars.status ++ " (MOCK)",
    employeeId: vars.empId,
    mockMode: true
}
]]></ee:set-payload>
                    </ee:message>
                </ee:transform>
            </on-error-continue>

        </error-handler>
        </try>
    </flow>

</mule>