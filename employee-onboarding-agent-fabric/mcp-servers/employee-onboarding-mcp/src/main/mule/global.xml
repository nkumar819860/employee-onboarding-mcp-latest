<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">

	<!-- ✅ 1. FIXED: Properties FIRST -->
	<configuration-properties file="${env}.yaml" />

	<!-- global.xml -->
	<global-property doc:name="Global Property" doc:id="084073d4-b919-4860-8243-7463949fc13a" name="env" value="local" />
	<error-handler name="GLOBAL-Error-Handler">
		<on-error-propagate type="ANY">
			<ee:transform>
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    timestamp: now(),
    status: 500,
    error: error.errorType,
    message: error.description default "Internal error",
    path: attributes.requestPath default "unknown"
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
		</on-error-propagate>
	</error-handler>

	<!-- ✅ CORRECT REFERENCE -->
	<configuration
		defaultErrorHandler-ref="GLOBAL-Error-Handler" />


	<db:config name="Database_Config">
		<db:generic-connection url="${db.url}"
			driverClassName="${db.driver}" user="${db.user}"
			password="${db.password}" />
	</db:config>

	<http:listener-config name="HTTP_Listener_config">
		<http:listener-connection host="0.0.0.0"
			port="8081" />
	</http:listener-config>


</mule>
