<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">

	<!-- ✅ Load Properties Configuration -->
	<configuration-properties file="config.properties" />
	
	<!-- Environment-specific properties override -->
	<error-handler name="GLOBAL-Error-Handler">
		<on-error-propagate type="ANY">
			<ee:transform>
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    timestamp: now(),
    status: 500,
    error: error.errorType,
    message: error.description default "Internal error",
    path: attributes.requestPath default "unknown"
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
		</on-error-propagate>
	</error-handler>

	<!-- ✅ CORRECT REFERENCE -->
	<configuration
		defaultErrorHandler-ref="GLOBAL-Error-Handler" />


	<!-- ✅ Database Configuration with Environment-based Selection -->
	<!-- PostgreSQL Configuration (Local Development) -->
	<db:config name="PostgreSQL_Database_Config" doc:name="PostgreSQL Database Config" 
	           doc:description="PostgreSQL connection for local development">
		<db:generic-connection 
			url="${db.postgres.url}" 
			driverClassName="${db.postgres.driverClassName}" 
			user="${db.postgres.username}" 
			password="${db.postgres.password}" />
	</db:config>

	<!-- H2 In-Memory Configuration (Cloud/Testing) -->
	<db:config name="H2_Database_Config" doc:name="H2 Database Config"
	           doc:description="H2 in-memory connection for cloud deployment">
		<db:generic-connection 
			url="${db.h2.url}" 
			driverClassName="${db.h2.driverClassName}" 
			user="${db.h2.username}" 
			password="${db.h2.password}" />
	</db:config>

	<!-- Primary Database Config - dynamically selected -->
	<db:config name="Database_Config" doc:name="Database Config">
		<db:generic-connection 
			url="${db.active.url}" 
			driverClassName="${db.active.driverClassName}" 
			user="${db.active.username}" 
			password="${db.active.password}" />
	</db:config>

	<!-- ✅ HTTP Listener with Property-based Configuration -->
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener Config">
		<http:listener-connection 
			host="${http.host}" 
			port="${http.port}" />
	</http:listener-config>


</mule>
